# filter, registrarion year before 2023 and exclude anonimous and left coutries##
hivdb <- patient %>%
left_join(vlst, by = c("regnum" = "id")) %>%
anti_join(anonims, by = c("regnum" = "id")) %>% # mutate(vdt = year(lst), ddt = year(deathfixdate))
left_join(prsns, by = c("doctorid" = "personellid")) %>% ## connect to personell db
mutate(sex = ifelse(genderid == 4, "M", "F"),
rgy = year(regdate),
dob = year(birthdate),
age = as.duration(interval(birthdate,repyear)) %/% as.duration(years(1)),
deathy = year(deathdate),
trroute = case_when(transferid == '47' ~ "IDU",
transferid == '48' & sex == "M" ~ "MHETERO",
transferid == '48' & sex == "F" ~ "FHETERO",
transferid == '49' ~ "MSM",
transferid %in% c('50', '51', '52') ~ "OTHER",
is.na(transferid) ~ "OTHER"),
agrgsex = case_when(age < 15 ~ "<15",
age >= 15 & sex == "M" ~ "M15+",
age >= 15 & sex == "F" ~ "F15+"),
agect = cut(age, c(-1,14,24,1000), c("0-14","15-24", "25+"))) %>%
filter(!is.na(regnum), rgy <= repyear, (is.na(deathy) | deathy >repyear), (is.na(visstt) | visstt != 255)) %>% # (!is.na(visstt) |
add_count(doctorname) %>%
add_tally() %>%
mutate(doctncount  = n, totaln = nn, percntdoctnm = round(n/nn*100, 0)) %>%
select(c(regnum,  lastvdate, visstt, deathy, regdate, age, agrgsex, sex, agect, rgy, arvdate, trroute, doctorname, doctncount, totaln, percntdoctnm))
# filter, registrarion year before 2023 and exclude anonimous and left coutries##
hivdb <- patient %>%
left_join(vlst, by = c("regnum" = "id")) %>%
anti_join(anonims, by = c("regnum" = "id")) %>% # mutate(vdt = year(lst), ddt = year(deathfixdate))
left_join(prsns, by = c("doctorid" = "personellid")) %>% ## connect to personell db
mutate(sex = ifelse(genderid == 4, "M", "F"),
rgy = year(regdate),
dob = year(birthdate),
age = as.duration(interval(birthdate,repyear)) %/% as.duration(years(1)),
deathy = year(deathdate),
trroute = case_when(transferid == '47' ~ "IDU",
transferid == '48' & sex == "M" ~ "MHETERO",
transferid == '48' & sex == "F" ~ "FHETERO",
transferid == '49' ~ "MSM",
transferid %in% c('50', '51', '52') ~ "OTHER",
is.na(transferid) ~ "OTHER"),
agrgsex = case_when(age < 15 ~ "<15",
age >= 15 & sex == "M" ~ "M15+",
age >= 15 & sex == "F" ~ "F15+"),
agect = cut(age, c(-1,14,24,1000), c("0-14","15-24", "25+"))) %>%
filter(!is.na(regnum), rgy <= repyear, (is.na(deathy) | deathy >repyear), (is.na(visstt) | visstt != 255)) %>% # (!is.na(visstt) |
add_count(doctorname) %>%
add_tally() %>%
mutate(doctncount  = n, totaln = nn, percntdoctnm = round(n/nn*100, 0)) %>%
select(c(regnum,  lastvdate, visstt, deathy, regdate, age, agrgsex, sex, agect, rgy, arvdate, trroute, doctorname, doctncount, totaln, percntdoctnm))
names(hivdb)
glimpse(hivdb)
# filter, registrarion year before 2023 and exclude anonimous and left coutries##
hivdb <- patient %>%
left_join(vlst, by = c("regnum" = "id")) %>%
anti_join(anonims, by = c("regnum" = "id")) %>% # mutate(vdt = year(lst), ddt = year(deathfixdate))
left_join(prsns, by = c("doctorid" = "personellid")) %>% ## connect to personell db
mutate(sex = ifelse(genderid == 4, "M", "F"),
rgy = year(regdate),
dob = year(birthdate),
age = as.duration(interval(birthdate,repyear)) %/% as.duration(years(1)),
deathy = year(deathdate),
trroute = case_when(transferid == '47' ~ "IDU",
transferid == '48' & sex == "M" ~ "MHETERO",
transferid == '48' & sex == "F" ~ "FHETERO",
transferid == '49' ~ "MSM",
transferid %in% c('50', '51', '52') ~ "OTHER",
is.na(transferid) ~ "OTHER"),
agrgsex = case_when(age < 15 ~ "<15",
age >= 15 & sex == "M" ~ "M15+",
age >= 15 & sex == "F" ~ "F15+"),
agect = cut(age, c(-1,14,24,1000), c("0-14","15-24", "25+"))) %>%
filter(!is.na(regnum), rgy <= repyear, (is.na(deathy) | deathy >repyear), (is.na(visstt) | visstt != 255)) %>% # (!is.na(visstt) |
add_count(doctorname) %>%
add_tally() %>%
mutate(doctncount  = n, totaln = nn, percntdoctnm = round(n/nn*100, 3)) %>%
select(c(regnum,  lastvdate, visstt, deathy, regdate, age, agrgsex, sex, agect, rgy, arvdate, trroute, doctorname, doctncount, totaln, percntdoctnm))
# filter, registrarion year before 2023 and exclude anonimous and left coutries##
hivdb <- patient %>%
left_join(vlst, by = c("regnum" = "id")) %>%
anti_join(anonims, by = c("regnum" = "id")) %>% # mutate(vdt = year(lst), ddt = year(deathfixdate))
left_join(prsns, by = c("doctorid" = "personellid")) %>% ## connect to personell db
mutate(sex = ifelse(genderid == 4, "M", "F"),
rgy = year(regdate),
dob = year(birthdate),
age = as.duration(interval(birthdate,repyear)) %/% as.duration(years(1)),
deathy = year(deathdate),
trroute = case_when(transferid == '47' ~ "IDU",
transferid == '48' & sex == "M" ~ "MHETERO",
transferid == '48' & sex == "F" ~ "FHETERO",
transferid == '49' ~ "MSM",
transferid %in% c('50', '51', '52') ~ "OTHER",
is.na(transferid) ~ "OTHER"),
agrgsex = case_when(age < 15 ~ "<15",
age >= 15 & sex == "M" ~ "M15+",
age >= 15 & sex == "F" ~ "F15+"),
agect = cut(age, c(-1,14,24,1000), c("0-14","15-24", "25+"))) %>%
filter(!is.na(regnum), rgy <= repyear, (is.na(deathy) | deathy >repyear), (is.na(visstt) | visstt != 255)) %>% # (!is.na(visstt) |
add_count(doctorname) %>%
add_tally() %>%
mutate(doctncount  = n, totaln = nn, percntdoctnm = round(n/nn*100, 2)) %>%
select(c(regnum,  lastvdate, visstt, deathy, regdate, age, agrgsex, sex, agect, rgy, arvdate, trroute, doctorname, doctncount, totaln, percntdoctnm))
190/7275
190/7275*100
## patients by dotctors after cleaning
doctors <- hivdb %>%
count(doctorname) %>%
arrange(desc(n))
doctors
## count doctors with lowest patients
noflwpdoct <- hivdb %>%
filter(prcntdctnm < 1)
# filter, registrarion year before 2023 and exclude anonimous and left coutries##
hivdb <- patient %>%
left_join(vlst, by = c("regnum" = "id")) %>%
anti_join(anonims, by = c("regnum" = "id")) %>% # mutate(vdt = year(lst), ddt = year(deathfixdate))
left_join(prsns, by = c("doctorid" = "personellid")) %>% ## connect to personell db
mutate(sex = ifelse(genderid == 4, "M", "F"),
rgy = year(regdate),
dob = year(birthdate),
age = as.duration(interval(birthdate,repyear)) %/% as.duration(years(1)),
deathy = year(deathdate),
trroute = case_when(transferid == '47' ~ "IDU",
transferid == '48' & sex == "M" ~ "MHETERO",
transferid == '48' & sex == "F" ~ "FHETERO",
transferid == '49' ~ "MSM",
transferid %in% c('50', '51', '52') ~ "OTHER",
is.na(transferid) ~ "OTHER"),
agrgsex = case_when(age < 15 ~ "<15",
age >= 15 & sex == "M" ~ "M15+",
age >= 15 & sex == "F" ~ "F15+"),
agect = cut(age, c(-1,14,24,1000), c("0-14","15-24", "25+"))) %>%
filter(!is.na(regnum), rgy <= repyear, (is.na(deathy) | deathy >repyear), (is.na(visstt) | visstt != 255)) %>% # (!is.na(visstt) |
add_count(doctorname) %>%
add_tally() %>%
mutate(doctncount  = n, totaln = nn, prcntdctnm = round(n/nn*100, 2)) %>%
select(c(regnum,  lastvdate, visstt, deathy, regdate, age, agrgsex, sex, agect, rgy, arvdate, trroute, doctorname, doctncount, totaln, prcntdctnm))
names(hivdb)
glimpse(hivdb)
## patients by dotctors after cleaning
doctors <- hivdb %>%
count(doctorname) %>%
arrange(desc(n))
doctors
## count doctors with lowest patients
noflwpdoct <- hivdb %>%
filter(prcntdctnm < 1)
noflwpdoct
##
write.table(vlst,  paste0(getwd(), "/data/vlst", Sys.Date(), ".xlsx", sep = ""), row.names=F, na="")
##
write.table(noflwpdoct,  paste0(getwd(), "/data/noflwpdoct", Sys.Date(), ".xlsx", sep = ""), row.names=F, na="")
# usage
packages <- c("installr", "RPostgres", "dplyr","lubridate",
"ggplot2","tidyr", "DBI", "gtsummary", "xlsx",
"readxl","readr", "pdftools", "janitor",
"stringr", "gtools", "emayili", "bit64")
ipak(packages)
# usage
packages <- c("installr", "RPostgres", "dplyr","lubridate",
"ggplot2","tidyr", "DBI", "gtsummary", "openxlsx",
"readxl","readr", "pdftools", "janitor",
"stringr", "gtools", "emayili", "bit64")
ipak(packages)
##
write.xlsx(noflwpdoct,  paste0(getwd(), "/data/noflwpdoct", Sys.Date(), ".xlsx", sep = ""), row.names=F, na="")
##
write.xlsx(noflwpdoct,  paste0(getwd(), "/data/noflwpdoct", Sys.Date(), ".xlsx", sep = ""), rowNames=F, na="")
## select doctors with <1% of patients from total
noflwpdoct <- hivdb %>%
filter(prcntdctnm < 1) %>%
select(regnum, doctorname)
##
noflwpdoct
##
write.xlsx(noflwpdoct,  paste0(getwd(), "/data/noflwpdoct", Sys.Date(), ".xlsx", sep = ""), rowNames=F, na="")
# filter, registrarion year before 2023 and exclude anonimous and left coutries##
hivdb <- patient %>%
left_join(vlst, by = c("regnum" = "id")) %>%
anti_join(anonims, by = c("regnum" = "id")) %>% # mutate(vdt = year(lst), ddt = year(deathfixdate))
left_join(prsns, by = c("doctorid" = "personellid")) %>% ## connect to personell db
mutate(sex = ifelse(genderid == 4, "M", "F"),
rgy = year(regdate),
dob = year(birthdate),
age = as.duration(interval(birthdate,repyear)) %/% as.duration(years(1)),
deathy = year(deathdate),
trroute = case_when(transferid == '47' ~ "IDU",
transferid == '48' & sex == "M" ~ "MHETERO",
transferid == '48' & sex == "F" ~ "FHETERO",
transferid == '49' ~ "MSM",
transferid %in% c('50', '51', '52') ~ "OTHER",
is.na(transferid) ~ "OTHER"),
agrgsex = case_when(age < 15 ~ "<15",
age >= 15 & sex == "M" ~ "M15+",
age >= 15 & sex == "F" ~ "F15+"),
agect = cut(age, c(-1,14,24,1000), c("0-14","15-24", "25+"))) %>%
filter(!is.na(regnum), rgy <= repyear, (is.na(deathy) | deathy >repyear), (is.na(visstt) | visstt != 255)) %>% # (!is.na(visstt) |
add_count(doctorname) %>%
add_tally() %>%
mutate(doctncount  = n, totaln = nn, prcntdctnm = round(n/nn*100, 2)) %>%
select(c(regnum, lastvdate, visstt, deathy, regdate, age, agrgsex, sex, agect, rgy, arvdate, trroute, doctorname, doctncount, totaln, prcntdctnm))
names(hivdb)
glimpse(hivdb)
doctors
## select doctors with <1% of patients from total
noflwpdoct <- hivdb %>%
filter(prcntdctnm < 1) %>%
select(regnum, doctorname)
## selected list of patients with less then 1% from total
noflwpdoct
## write small number of patient to check by doctors.
write.xlsx(noflwpdoct,  paste0(getwd(), "/data/noflwpdoct", Sys.Date(), ".xlsx", sep = ""), rowNames=F, na="")
# filter, registrarion year before 2023 and exclude anonimous and left coutries##
hivdb <- patient %>%
left_join(vlst, by = c("regnum" = "id")) %>%
anti_join(anonims, by = c("regnum" = "id")) %>% # mutate(vdt = year(lst), ddt = year(deathfixdate))
left_join(prsns, by = c("doctorid" = "personellid")) %>% ## connect to personell db
mutate(sex = ifelse(genderid == 4, "M", "F"),
rgy = year(regdate),
dob = year(birthdate),
age = as.duration(interval(birthdate,repyear)) %/% as.duration(years(1)),
deathy = year(deathdate),
trroute = case_when(transferid == '47' ~ "IDU",
transferid == '48' & sex == "M" ~ "MHETERO",
transferid == '48' & sex == "F" ~ "FHETERO",
transferid == '49' ~ "MSM",
transferid %in% c('50', '51', '52') ~ "OTHER",
is.na(transferid) ~ "OTHER"),
agrgsex = case_when(age < 15 ~ "<15",
age >= 15 & sex == "M" ~ "M15+",
age >= 15 & sex == "F" ~ "F15+"),
agect = cut(age, c(-1,14,24,1000), c("0-14","15-24", "25+")),
nnd = count(n())) %>%
filter(!is.na(regnum), rgy <= repyear, (is.na(deathy) | deathy >repyear), (is.na(visstt) | visstt != 255)) %>% # (!is.na(visstt) |
add_count(doctorname) %>%
add_tally() %>%
mutate(doctncount  = n, totaln = nn, prcntdctnm = round(n/nn*100, 2)) %>%
select(c(regnum, lastvdate, visstt, deathy, regdate, age, agrgsex, sex, agect, rgy, arvdate, trroute, doctorname, doctncount, totaln, prcntdctnm))
# filter, registrarion year before 2023 and exclude anonimous and left coutries##
hivdb <- patient %>%
left_join(vlst, by = c("regnum" = "id")) %>%
anti_join(anonims, by = c("regnum" = "id")) %>% # mutate(vdt = year(lst), ddt = year(deathfixdate))
left_join(prsns, by = c("doctorid" = "personellid")) %>% ## connect to personell db
mutate(sex = ifelse(genderid == 4, "M", "F"),
rgy = year(regdate),
dob = year(birthdate),
age = as.duration(interval(birthdate,repyear)) %/% as.duration(years(1)),
deathy = year(deathdate),
trroute = case_when(transferid == '47' ~ "IDU",
transferid == '48' & sex == "M" ~ "MHETERO",
transferid == '48' & sex == "F" ~ "FHETERO",
transferid == '49' ~ "MSM",
transferid %in% c('50', '51', '52') ~ "OTHER",
is.na(transferid) ~ "OTHER"),
agrgsex = case_when(age < 15 ~ "<15",
age >= 15 & sex == "M" ~ "M15+",
age >= 15 & sex == "F" ~ "F15+"),
agect = cut(age, c(-1,14,24,1000), c("0-14","15-24", "25+"),
nnd = (coun = n()))) %>%
filter(!is.na(regnum), rgy <= repyear, (is.na(deathy) | deathy >repyear), (is.na(visstt) | visstt != 255)) %>% # (!is.na(visstt) |
add_count(doctorname) %>%
add_tally() %>%
mutate(doctncount  = n, totaln = nn, prcntdctnm = round(n/nn*100, 2)) %>%
select(c(regnum, lastvdate, visstt, deathy, regdate, age, agrgsex, sex, agect, rgy, arvdate, trroute, doctorname, doctncount, totaln, prcntdctnm))
# filter, registrarion year before 2023 and exclude anonimous and left coutries##
hivdb <- patient %>%
left_join(vlst, by = c("regnum" = "id")) %>%
anti_join(anonims, by = c("regnum" = "id")) %>% # mutate(vdt = year(lst), ddt = year(deathfixdate))
left_join(prsns, by = c("doctorid" = "personellid")) %>% ## connect to personell db
mutate(sex = ifelse(genderid == 4, "M", "F"),
rgy = year(regdate),
dob = year(birthdate),
age = as.duration(interval(birthdate,repyear)) %/% as.duration(years(1)),
deathy = year(deathdate),
trroute = case_when(transferid == '47' ~ "IDU",
transferid == '48' & sex == "M" ~ "MHETERO",
transferid == '48' & sex == "F" ~ "FHETERO",
transferid == '49' ~ "MSM",
transferid %in% c('50', '51', '52') ~ "OTHER",
is.na(transferid) ~ "OTHER"),
agrgsex = case_when(age < 15 ~ "<15",
age >= 15 & sex == "M" ~ "M15+",
age >= 15 & sex == "F" ~ "F15+"),
agect = cut(age, c(-1,14,24,1000), c("0-14","15-24", "25+"),
nnd = (coun = n()))) %>%
filter(!is.na(regnum), rgy <= repyear, (is.na(deathy) | deathy >repyear), (is.na(visstt) | visstt != 255)) %>% # (!is.na(visstt) |
add_count(doctorname) %>%
add_tally() %>%
mutate(doctncount  = n, totaln = nn, prcntdctnm = round(n/nn*100, 2)) %>%
select(c(regnum, nnd, lastvdate, visstt, deathy, regdate, age, agrgsex, sex, agect, rgy, arvdate, trroute, doctorname, doctncount, totaln, prcntdctnm))
names(hivdb)
# filter, registrarion year before 2023 and exclude anonimous and left coutries##
hivdb <- patient %>%
left_join(vlst, by = c("regnum" = "id")) %>%
anti_join(anonims, by = c("regnum" = "id")) %>% # mutate(vdt = year(lst), ddt = year(deathfixdate))
left_join(prsns, by = c("doctorid" = "personellid")) %>% ## connect to personell db
mutate(sex = ifelse(genderid == 4, "M", "F"),
rgy = year(regdate),
dob = year(birthdate),
age = as.duration(interval(birthdate,repyear)) %/% as.duration(years(1)),
deathy = year(deathdate),
trroute = case_when(transferid == '47' ~ "IDU",
transferid == '48' & sex == "M" ~ "MHETERO",
transferid == '48' & sex == "F" ~ "FHETERO",
transferid == '49' ~ "MSM",
transferid %in% c('50', '51', '52') ~ "OTHER",
is.na(transferid) ~ "OTHER"),
agrgsex = case_when(age < 15 ~ "<15",
age >= 15 & sex == "M" ~ "M15+",
age >= 15 & sex == "F" ~ "F15+"),
agect = cut(age, c(-1,14,24,1000), c("0-14","15-24", "25+"),
nnd = (coun = n()))) %>%
filter(!is.na(regnum), rgy <= repyear, (is.na(deathy) | deathy >repyear), (is.na(visstt) | visstt != 255)) %>% # (!is.na(visstt) |
add_count(doctorname) %>%
add_tally() %>%
mutate(doctncount  = n, totaln = nn, prcntdctnm = round(n/nn*100, 2)) %>%
select(c(regnum, lastvdate, visstt, deathy, regdate, age, agrgsex, sex, agect, rgy, arvdate, trroute, doctorname, doctncount, totaln, prcntdctnm))
# filter, registrarion year before 2023 and exclude anonimous and left coutries##
hivdb <- patient %>%
left_join(vlst, by = c("regnum" = "id")) %>%
anti_join(anonims, by = c("regnum" = "id")) %>% # mutate(vdt = year(lst), ddt = year(deathfixdate))
left_join(prsns, by = c("doctorid" = "personellid")) %>% ## connect to personell db
mutate(sex = ifelse(genderid == 4, "M", "F"),
rgy = year(regdate),
dob = year(birthdate),
age = as.duration(interval(birthdate,repyear)) %/% as.duration(years(1)),
deathy = year(deathdate),
trroute = case_when(transferid == '47' ~ "IDU",
transferid == '48' & sex == "M" ~ "MHETERO",
transferid == '48' & sex == "F" ~ "FHETERO",
transferid == '49' ~ "MSM",
transferid %in% c('50', '51', '52') ~ "OTHER",
is.na(transferid) ~ "OTHER"),
agrgsex = case_when(age < 15 ~ "<15",
age >= 15 & sex == "M" ~ "M15+",
age >= 15 & sex == "F" ~ "F15+"),
agect = cut(age, c(-1,14,24,1000), c("0-14","15-24", "25+"),
nnd = (coun = n()))) %>%
filter(!is.na(regnum), rgy <= repyear, (is.na(deathy) | deathy >repyear), (is.na(visstt) | visstt != 255)) %>% # (!is.na(visstt) |
add_count(doctorname) %>%
add_tally() %>%
mutate(doctncount  = n, totaln = nn, prcntdctnm = round(n/nn*100, 2))
agect = cut(age, c(-1,14,24,1000), c("0-14","15-24", "25+")) %>%
# filter, registrarion year before 2023 and exclude anonimous and left coutries##
hivdb <- patient %>%
left_join(vlst, by = c("regnum" = "id")) %>%
anti_join(anonims, by = c("regnum" = "id")) %>% # mutate(vdt = year(lst), ddt = year(deathfixdate))
left_join(prsns, by = c("doctorid" = "personellid")) %>% ## connect to personell db
mutate(sex = ifelse(genderid == 4, "M", "F"),
rgy = year(regdate),
dob = year(birthdate),
age = as.duration(interval(birthdate,repyear)) %/% as.duration(years(1)),
deathy = year(deathdate),
trroute = case_when(transferid == '47' ~ "IDU",
transferid == '48' & sex == "M" ~ "MHETERO",
transferid == '48' & sex == "F" ~ "FHETERO",
transferid == '49' ~ "MSM",
transferid %in% c('50', '51', '52') ~ "OTHER",
is.na(transferid) ~ "OTHER"),
agrgsex = case_when(age < 15 ~ "<15",
age >= 15 & sex == "M" ~ "M15+",
age >= 15 & sex == "F" ~ "F15+"),
agect = cut(age, c(-1,14,24,1000), c("0-14","15-24", "25+"))) %>%
filter(!is.na(regnum), rgy <= repyear, (is.na(deathy) | deathy >repyear), (is.na(visstt) | visstt != 255)) %>% # (!is.na(visstt) |
add_count(doctorname) %>%
add_tally() %>%
mutate(doctncount  = n, totaln = nn, prcntdctnm = round(n/nn*100, 2)) %>%
select(c(regnum, lastvdate, visstt, deathy, regdate, age, agrgsex, sex, agect, rgy, arvdate, trroute, doctorname, doctncount, totaln, prcntdctnm))
names(hivdb)
glimpse(hivdb)
# filter, registrarion year before 2023 and exclude anonimous and left coutries##
hivdb <- patient %>%
left_join(vlst, by = c("regnum" = "id")) %>%
anti_join(anonims, by = c("regnum" = "id")) %>% # mutate(vdt = year(lst), ddt = year(deathfixdate))
left_join(prsns, by = c("doctorid" = "personellid")) %>% ## connect to personell db
mutate(sex = ifelse(genderid == 4, "M", "F"),
rgy = year(regdate),
dob = year(birthdate),
age = as.duration(interval(birthdate,repyear)) %/% as.duration(years(1)),
deathy = year(deathdate),
trroute = case_when(transferid == '47' ~ "IDU",
transferid == '48' & sex == "M" ~ "MHETERO",
transferid == '48' & sex == "F" ~ "FHETERO",
transferid == '49' ~ "MSM",
transferid %in% c('50', '51', '52') ~ "OTHER",
is.na(transferid) ~ "OTHER"),
agrgsex = case_when(age < 15 ~ "<15",
age >= 15 & sex == "M" ~ "M15+",
age >= 15 & sex == "F" ~ "F15+"),
agect = cut(age, c(-1,14,24,1000), c("0-14","15-24", "25+"))) %>%
filter(!is.na(regnum), rgy <= repyear, (is.na(deathy) | deathy >repyear), (is.na(visstt) | visstt != 255)) %>% # (!is.na(visstt) |
add_count(doctorname, name = "doctncount") %>%
add_tally(name = "totaln") %>%
mutate( prcntdctnm = round(n/nn*100, 2)) %>%
select(c(regnum, lastvdate, visstt, deathy, regdate, age, agrgsex, sex, agect, rgy, arvdate, trroute, doctorname, doctncount, totaln, prcntdctnm))
# filter, registrarion year before 2023 and exclude anonimous and left coutries##
hivdb <- patient %>%
left_join(vlst, by = c("regnum" = "id")) %>%
anti_join(anonims, by = c("regnum" = "id")) %>% # mutate(vdt = year(lst), ddt = year(deathfixdate))
left_join(prsns, by = c("doctorid" = "personellid")) %>% ## connect to personell db
mutate(sex = ifelse(genderid == 4, "M", "F"),
rgy = year(regdate),
dob = year(birthdate),
age = as.duration(interval(birthdate,repyear)) %/% as.duration(years(1)),
deathy = year(deathdate),
trroute = case_when(transferid == '47' ~ "IDU",
transferid == '48' & sex == "M" ~ "MHETERO",
transferid == '48' & sex == "F" ~ "FHETERO",
transferid == '49' ~ "MSM",
transferid %in% c('50', '51', '52') ~ "OTHER",
is.na(transferid) ~ "OTHER"),
agrgsex = case_when(age < 15 ~ "<15",
age >= 15 & sex == "M" ~ "M15+",
age >= 15 & sex == "F" ~ "F15+"),
agect = cut(age, c(-1,14,24,1000), c("0-14","15-24", "25+"))) %>%
filter(!is.na(regnum), rgy <= repyear, (is.na(deathy) | deathy >repyear), (is.na(visstt) | visstt != 255)) %>% # (!is.na(visstt) |
add_count(doctorname, name = "doctncount") %>%
add_tally(name = "totaln") %>%
mutate( prcntdctnm = round(doctncount/totaln * 100, 2)) %>%
select(c(regnum, lastvdate, visstt, deathy, regdate, age, agrgsex, sex, agect, rgy, arvdate, trroute, doctorname, doctncount, totaln, prcntdctnm))
names(hivdb)
glimpse(hivdb)
# filter, registrarion year before 2023 and exclude anonimous and left coutries##
hivdb <- patient %>%
left_join(vlst, by = c("regnum" = "id")) %>%
anti_join(anonims, by = c("regnum" = "id")) %>% # mutate(vdt = year(lst), ddt = year(deathfixdate))
left_join(prsns, by = c("doctorid" = "personellid")) %>% ## connect to personell db
mutate(sex = ifelse(genderid == 4, "M", "F"),
rgy = year(regdate),
dob = year(birthdate),
age = as.duration(interval(birthdate,repyear)) %/% as.duration(years(1)),
deathy = year(deathdate),
trroute = case_when(transferid == '47' ~ "IDU",
transferid == '48' & sex == "M" ~ "MHETERO",
transferid == '48' & sex == "F" ~ "FHETERO",
transferid == '49' ~ "MSM",
transferid %in% c('50', '51', '52') ~ "OTHER",
is.na(transferid) ~ "OTHER"),
agrgsex = case_when(age < 15 ~ "<15",
age >= 15 & sex == "M" ~ "M15+",
age >= 15 & sex == "F" ~ "F15+"),
agect = cut(age, c(-1,14,24,1000), c("0-14","15-24", "25+"))) %>%
filter(!is.na(regnum), rgy <= repyear, (is.na(deathy) | deathy >repyear), (is.na(visstt) | visstt != 255)) %>% # (!is.na(visstt) |
add_count(doctorname, wt = sex, name = "doctncount") %>%
add_tally(name = "totaln") %>%
mutate( prcntdctnm = round(doctncount/totaln * 100, 2)) %>%
select(c(regnum, lastvdate, visstt, deathy, regdate, age, agrgsex, sex, agect, rgy, arvdate, trroute, doctorname, doctncount, totaln, prcntdctnm))
# filter, registrarion year before 2023 and exclude anonimous and left coutries##
hivdb <- patient %>%
left_join(vlst, by = c("regnum" = "id")) %>%
anti_join(anonims, by = c("regnum" = "id")) %>% # mutate(vdt = year(lst), ddt = year(deathfixdate))
left_join(prsns, by = c("doctorid" = "personellid")) %>% ## connect to personell db
mutate(sex = ifelse(genderid == 4, "M", "F"),
rgy = year(regdate),
dob = year(birthdate),
age = as.duration(interval(birthdate,repyear)) %/% as.duration(years(1)),
deathy = year(deathdate),
trroute = case_when(transferid == '47' ~ "IDU",
transferid == '48' & sex == "M" ~ "MHETERO",
transferid == '48' & sex == "F" ~ "FHETERO",
transferid == '49' ~ "MSM",
transferid %in% c('50', '51', '52') ~ "OTHER",
is.na(transferid) ~ "OTHER"),
agrgsex = case_when(age < 15 ~ "<15",
age >= 15 & sex == "M" ~ "M15+",
age >= 15 & sex == "F" ~ "F15+"),
agect = cut(age, c(-1,14,24,1000), c("0-14","15-24", "25+"))) %>%
filter(!is.na(regnum), rgy <= repyear, (is.na(deathy) | deathy >repyear), (is.na(visstt) | visstt != 255)) %>% # (!is.na(visstt) |
add_count(doctorname, wt = age, name = "doctncount") %>%
add_tally(name = "totaln") %>%
mutate( prcntdctnm = round(doctncount/totaln * 100, 2)) %>%
select(c(regnum, lastvdate, visstt, deathy, regdate, age, agrgsex, sex, agect, rgy, arvdate, trroute, doctorname, doctncount, totaln, prcntdctnm))
names(hivdb)
glimpse(hivdb)
## cascade code
rm(list=ls())  # remove all data
dev.off()
print(sessionInfo(), l=F)
## packages
## load packages
ipak <- function(pkg){
new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
if (length(new.pkg))
install.packages(new.pkg, dependencies = TRUE)
sapply(pkg, require, character.only = TRUE)
}
# usage
packages <- c("installr", "RPostgres", "dplyr","lubridate",
"ggplot2","tidyr", "DBI", "gtsummary", "openxlsx",
"readxl","readr", "pdftools", "janitor",
"stringr", "gtools", "emayili", "bit64")
ipak(packages)
### set wirking directory
workwd <- "~/OTO/Oficial/DB/HIVcascade"
homewd <- "/Users/oto/Documents/OTO/DB/HIVcascade"
if(isTRUE(file.info(workwd) [1,"isdir"])){
setwd(workwd);dir() # dir.create is used to creatge not existing directory
}else{
(isTRUE(file.info(homewd)[1,"isdir"]))
setwd(homewd);dir()
}
getwd()
### import from postgreslq
source("code/Connect_to_PGSQL.R") # load data from postgresql, you should enter database name
##
### create final date variable#
frdt <- '2023-01-01'
repyear <- '2023-12-31'
labrt <- '2023-12-31'
## dada
glimpse(visit)
glimpse(patient)
